dist: focal

language: go

go:
  - "1.17"

addons:
  apt:
    packages:
      - docker-ce

stages:
  - compile
  - test
  - deploy

jobs:
  include:
    - stage: compile
      name: GO Compile
      os: linux
      arch: amd64
      script:
          - go build cmd/go-proxy/main.go
    - stage: test
      name: GO Test
      os: linux
      arch: amd64
      script:
          - go test ./...
    - stage: test
      name: Docker build
      os: linux
      arch: amd64
      script:
          - docker buildx build --platform linux/amd64 .
    - stage: deploy
      name: Docker Build and Repository Push
      if: branch = main and type = push
      os: linux
      arch: amd64
      script:
        - docker --version
        - docker login -u $DOCKER_USERNAME -p $DOCKER_PASSWORD
        - docker buildx build --platform linux/arm/v7 -t brunoshiroma/go-proxy:armv7-latest --push .
        - docker buildx build --platform linux/arm/v6 -t brunoshiroma/go-proxy:armv6-latest --push .
        - docker buildx build --platform linux/amd64 -t brunoshiroma/go-proxy:amd64-latest --push .
        - docker buildx build --platform linux/arm64/v8 -t brunoshiroma/go-proxy:aarch64-latest --push .
        - docker buildx build --platform linux/386 -t brunoshiroma/go-proxy:386-latest --push .
        - docker manifest create brunoshiroma/go-proxy:latest brunoshiroma/go-proxy:386-latest brunoshiroma/go-proxy:armv7-latest brunoshiroma/go-proxy:armv6-latest brunoshiroma/go-proxy:amd64-latest brunoshiroma/go-proxy:aarch64-latest
        - docker manifest push brunoshiroma/go-proxy:latest